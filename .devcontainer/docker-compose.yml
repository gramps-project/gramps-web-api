services:
  devcontainer:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ../..:/workspaces:cached
    command: sleep infinity
    environment:
      LANGUAGE: en
      OMP_NUM_THREADS: 1
      GRAMPSWEB_BASE_URL: http://localhost:8001
      GRAMPSWEB_USER_DB_URI: sqlite:////workspaces/web-api/data/users.sqlite
      GRAMPSWEB_MEDIA_BASE_DIR: /workspaces/web-api/data/media
      GRAMPSWEB_SEARCH_INDEX_DB_URI: sqlite:////workspaces/web-api/data/indexdir/search_index.db
      GRAMPSWEB_STATIC_PATH: /workspaces/web-api/data/static
      GRAMPSWEB_THUMBNAIL_CACHE_CONFIG__CACHE_DIR: /workspaces/web-api/data/thumbnail_cache
      GRAMPSWEB_REPORT_DIR: /workspaces/web-api/data/reports_cache
      GRAMPSWEB_EXPORT_DIR: /workspaces/web-api/data/export_cache
      GRAMPSHOME: /workspaces/web-api/data/
      GRAMPS_DATABASE_PATH: /workspaces/web-api/data/grampsdb
      GRAMPSWEB_TREE: "Gramps Web"
      # Do not use this value in production!!
      GRAMPSWEB_SECRET_KEY: QAVoeYDzkQves9iDZ5PkxfdUoVElVMVYPqz-QXha6yE
      GRAMPSWEB_CORS_ORIGINS: "*"
      GRAMPSWEB_VECTOR_EMBEDDING_MODEL: sentence-transformers/distiluse-base-multilingual-cased-v2
      # To use Ollama for embeddings instead of local SentenceTransformer,
      # start with: docker compose --profile ollama up -d
      # Then uncomment the following lines and comment out the line above:
      # GRAMPSWEB_EMBEDDING_BASE_URL: http://ollama:11434
      # GRAMPSWEB_VECTOR_EMBEDDING_MODEL: nomic-embed-text
      GRAMPSWEB_CELERY_CONFIG__broker_url: redis://redis:6379/0
      GRAMPSWEB_CELERY_CONFIG__result_backend: redis://redis:6379/0
      GRAMPSWEB_LOG_LEVEL: DEBUG
      GRAMPSWEB_FRONTEND_URL: ""

  redis:
    image: valkey/valkey:alpine
    restart: unless-stopped
    ports:
      - "6379:6379"

  ollama:
    image: ollama/ollama:latest
    profiles:
      - ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama

volumes:
  ollama-data:
